{% extends "auctions/layout.html" %} 
{% block title %} {{ listing.title }} {% endblock %}

{% block body %}
<h2 class="mb-4">{{ listing.title }}</h2>

{% if not listing.isActive %}
<div class="alert alert-danger" role="alert">
  Auction Closed. {% if listing.winner %} Winner:
  <strong>{{ listing.winner.username }}</strong> (${{ listing.price }}) {% else
  %} No bids have been placed yet. {% endif %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-6">
        {% if listing.imageUrl %}
        <img
          src="{{ listing.imageUrl }}"
          class="img-fluid mb-3"
          alt="{{ listing.title }}"
          style="max-height: 400px; object-fit: cover;"
        />
        {% else %}
        <p>No image available.</p>
        {% endif %}
    </div>

    <div class="col-md-6">
        <div class="card p-4 h-100" style="background: var(--surface-2);">
            <h4>Description</h4>
            <p>{{ listing.description }}</p>

            <hr />

            <div class="d-flex justify-content-between">
                <div>
                    <h4>Price Information</h4>
                    <p class="mb-1"><strong>Starting Price:</strong> ${{ listing.price }}</p>
                    <p class="mb-0">
                      <strong>Current Highest Bid:</strong>
                      <span class="text-primary fs-4">${{ current_price }}</span>
                    </p>
                    {% if highest_bid_user %}
                        <small class="text-muted">Last Bid by: {{ highest_bid_user }}</small>
                    {% endif %}
                </div>
                <div class="text-end">
                    <p class="mb-1"><strong>Category:</strong> {% if listing.category %}{{ listing.category.categoryName }}{% else %}N/A{% endif %}</p>
                    <p class="mb-0"><strong>Owner:</strong> {{ listing.owner.username }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
<hr />
<div class="row mt-4 mb-4 justify-content-center">
    <div class="col-md-8 col-lg-6"> 
        <div class="card p-4" style="background: var(--surface);">
            <h4>Auction Actions</h4>
            
            {% if user.is_authenticated %}
                {% if is_winner %}
                    <div class="alert alert-warning mt-2 mb-3">Congratulations! You won this auction.</div>
                {% endif %}

                <form action="{% url 'add_to_watchlist' listing.id %}" method="post" class="mb-3">
                  {% csrf_token %}
                  <button type="submit" class="btn {% if is_on_watchlist %}btn-secondary{% else %}btn-outline-secondary{% endif %} w-100">
                    {% if is_on_watchlist %} Remove from Watchlist {% else %} Add to Watchlist {% endif %}
                  </button>
                </form>

                {% if listing.isActive %}
                    <hr>
                    <h5 class="mt-2">Place a Bid</h5>
                    
                    <form action="{% url 'bid' listing.id %}" method="post" class="d-flex align-items-center">
                      {% csrf_token %} 
                      
                      <div class="flex-grow-1 me-2" style="margin-bottom: 0;">
                          {{ bid_form.as_p }}
                          <input type="submit" value="Place Bid" class="btn btn-primary" style="height: 46px;" />
                        </div>
                      
                      
                    </form>

                    {% if is_owner %}
                    <hr>
                    <form action="{% url 'close_auction' listing.id %}" method="post" class="mt-3">
                      {% csrf_token %}
                      <input type="submit" value="Close Auction" class="btn btn-danger" style="position: relative; left: 50%; transform: translateX(-50%);" onclick="return confirm('Are you sure you want to close this auction?');"/>
                    </form>
                    {% endif %} 
                {% endif %} 
                
            {% else %}
                <p class="text-muted">Please log in to place a bid, watch, or comment.</p>
            {% endif %}
        </div>
    </div>
</div>
<hr />
<div class="row">
    <div class="col-md-12">
        <h4 class="mt-4">Comments</h4>
        <ul class="list-group mb-3">
          {% for comment in comments %}
          <li class="list-group-item">
            <small class="text-muted"
              >{{ comment.author.username }} - {{ comment.timestamp|date:"d M Y H:i"
              }}</small
            >
            <p>{{ comment.message }}</p>
          </li>
          {% empty %}
          <li class="list-group-item">No comments yet.</li>
          {% endfor %}
        </ul>

        {% if user.is_authenticated %}
        <h5>Add a Comment</h5>
        <form action="{% url 'comment' listing.id %}" method="post">
          {% csrf_token %} {{ comment_form.as_p }}
          <input type="submit" value="Submit Comment" class="btn btn-secondary" />
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}